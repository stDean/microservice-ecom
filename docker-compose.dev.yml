# Extend the base configuration file
services:
  # --- API Gateway Development Overrides ---
  api-gateway:
    # Use the builder target for development
    build:
      target: builder
    environment:
      - NODE_ENV=development
      - JWT_SECRET=dev-jwt-secret-change-in-production
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:5173
      - PORT=3000
      - AUTH_SERVICE_URL=http://auth_service:3001
    # Mount volumes for hot-reloading
    volumes:
      - ./api-gateway:/app
      - /app/node_modules
    command: npm run dev
    develop:
      # Use the watch configuration from your individual file
      watch:
        - action: sync
          path: ./api-gateway/src
          target: /app/src
          ignore:
            - node_modules/
        - action: rebuild
          path: package.json

  # --- Auth Service Development Overrides ---
  auth-service:
    # Use the builder target for development
    build: 
      target: builder
      args:
        - NODE_ENV=development
    environment:
      PORT: 3001
      NODE_ENV: development
      # Easy-to-use development credentials
      POSTGRES_PASSWORD: example
      POSTGRES_USER: user
      POSTGRES_DB: auth_db
    # Mount volumes for hot-reloading
    volumes:
      - ./auth-service/src:/app/src:ro
      - ./auth-service/package.json:/app/package.json:ro
      - ./auth-service/tsconfig.json:/app/tsconfig.json:ro
      - /app/node_modules
    command: ["npm", "run", "dev"]
    # We remove the healthcheck here as it often gets in the way of rapid development restarts

  # --- Auth Migration Overrides ---
  auth-migrate:
    build:
      target: builder
      args:
        - NODE_ENV=development

  # --- Database Development Overrides ---
  auth-db:
    environment:
      # Matches the development credentials set above
      POSTGRES_PASSWORD: example
      POSTGRES_USER: user
      POSTGRES_DB: auth_db
    # Add a volume for persistent dev data
    volumes:
      - auth_db_data:/var/lib/postgresql/data

# Define volumes for persistent data
volumes:
  auth_db_data:
