# --- 1. Service Definitions ---
services:
  redis:
    image: redis:7-alpine
    networks:
      - ecom_network  
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes

  # Auth Database
  auth-db:
    image: postgres:15-alpine
    container_name: auth_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d auth_db"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - ecom_network

  # Product Database
  product-db:
    image: postgres:15-alpine
    container_name: product_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d product_db"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - ecom_network

  order-db:
    image: postgres:15-alpine
    container_name: order_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d order_db"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - ecom_network

  payment-db:
    image: postgres:15-alpine
    container_name: payment_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d order_db"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - ecom_network

  # The public entry point for the entire application
  api-gateway:
    container_name: api_gateway
    build:
      context: ./api-gateway
    image: api_gateway_image:1.0
    ports:
      - "3000:3000" # Expose the gateway publicly
    networks:
      - ecom_network
    restart: always
    depends_on:
      auth-service:
        condition: service_healthy 
      notification-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-catalog-service:
        condition: service_healthy
      cart-service: 
        condition: service_healthy
      payment-service:
        condition: service_healthy
      shipping-service:
        condition: service_healthy
    # Healthcheck for API Gateway
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3000,path:'/api/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # Authentication Service
  auth-service:
    container_name: auth_service
    build:
      context: ./auth-service
    image: auth_service_image:1.0
    expose:
      - "3001:3001" # Only expose internally to the network
    networks:
      - ecom_network
    restart: always
    # UPDATED: Healthcheck configuration for robust failure handling
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3001,path:'/api/v1/auth/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      auth-migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
      
  # Database Migration Service - Runs once and exits
  auth-migrate:
    container_name: auth_migrate
    build: 
      context: ./auth-service
      target: builder
      args:
        - NODE_ENV=development
    command: ["npm", "run", "db:push"]
    networks:
      - ecom_network
    depends_on:
      auth-db: # Correctly depends on 'auth-db'
        condition: service_healthy

  # Notification Service
  notification-service:
    build: 
      context: ./notification-service
    container_name: notification-service
    image: notification-service:latest
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3002,path:'/api/v1/notification/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      auth-service: 
        condition: service_healthy
      redis:
        condition: service_started

  user-service:
    build:
      context: ./user-service
    container_name: user_service
    image: user_service_image:latest
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3003,path:'/api/v1/users/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      user-db:
        condition: service_started
      redis:
        condition: service_started
  
  user-db:
    image: mongo
    networks:
      - ecom_network

  product-catalog-service:
    build:
      context: ./product-catalog-service
    container_name: product_catalog
    image: product_catalog_image:latest
    ports:
      - "3004:3004"
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3004,path:'/api/v1/productCatalog/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      product-migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started

  product-migrate:
    build: 
      context: ./product-catalog-service
      target: builder
      args:
        - NODE_ENV=development
    command: ["npm", "run", "db:push"]
    networks:
      - ecom_network
    depends_on:
      product-db: 
        condition: service_healthy

  cart-service:
    build:
      context: ./cart-service
    container_name: cart_service
    image: cart_service_image:latest
    ports:
      - "3005:3005"
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3005,path:'/api/v1/carts/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      redis:
        condition: service_started

  order-service:
    build:
      context: ./order-service
    container_name: order_service
    image: order_service_image:latest
    ports:
      - "3006:3006"
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3006,path:'/api/v1/orders/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      redis:
        condition: service_started
      order-migrate:
        condition: service_completed_successfully

  order-migrate:
    build: 
      context: ./order-service
      target: builder
      args:
        - NODE_ENV=development
    command: ["npm", "run", "db:push"]
    networks:
      - ecom_network
    depends_on:
      order-db: 
        condition: service_healthy

  payment-service:
    build:
      context: ./payment-service
    container_name: payment_service
    image: payment_service_image:latest
    ports:
      - "3007:3007"
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3007,path:'/api/v1/payments/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      redis:
        condition: service_started
      payment-migrate:
        condition: service_completed_successfully

  payment-migrate:
    build: 
      context: ./payment-service
      target: builder
      args:
        - NODE_ENV=development
    command: ["npm", "run", "db:push"]
    networks:
      - ecom_network
    depends_on:
      payment-db: 
        condition: service_healthy

  shipping-service:
    build:
      context: ./shipping-service
    container_name: shipping_service
    image: shipping_service_image:latest
    ports:
      - "3008:3008"
    environment:
      - PORT=3008
    networks:
      - ecom_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({host:'localhost',port:3008,path:'/api/v1/shipping/health',timeout:2000},(res)=>{if(res.statusCode===200){process.exit(0);}else{process.exit(1);}}).on('error',()=>process.exit(1)).end();"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      shipping-db:
        condition: service_started
      redis:
        condition: service_started
  
  shipping-db:
    image: mongo
    networks:
      - ecom_network

# --- 2. Networks ---
networks:
  ecom_network:
    driver: bridge
